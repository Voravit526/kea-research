---
import { detectLocale } from '../i18n';
import { createTranslator, getClientTranslations } from '../i18n/translations';
import TranslationScript from '../components/TranslationScript.astro';

interface Props {
  title?: string;
}

const locale = detectLocale(Astro.request);
const t = createTranslator(locale);

const { title = t('meta.title') } = Astro.props;

// RTL languages
const RTL_LOCALES = ['ar', 'he', 'fa', 'ur'];
const isRTL = RTL_LOCALES.includes(locale);
---

<!DOCTYPE html>
<html lang={locale} dir={isRTL ? 'rtl' : 'ltr'} data-bs-theme="auto">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title}</title>

  {/* Prevent theme flash - must run before page renders */}
  <script is:inline>
    (function() {
      var theme = localStorage.getItem('theme');
      var effectiveTheme;
      if (theme === 'dark') {
        effectiveTheme = 'dark';
      } else if (theme === 'light') {
        effectiveTheme = 'light';
      } else {
        // 'auto' or not set - use system preference
        effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      document.documentElement.setAttribute('data-bs-theme', effectiveTheme);
    })();
  </script>

  {/* Favicons */}
  <link rel="icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/favicon/favicon.svg">
  <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/favicon/favicon-96x96.png" sizes="96x96">
  <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/favicon/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/favicon/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-title" content={t('meta.title')}>
  <link rel="manifest" href="/assets/site.webmanifest">

  {/* Theme Colors */}
  <meta name="theme-color" content="#1A5F6C" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#2B3035" media="(prefers-color-scheme: dark)">

  {/* Preconnect */}
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  {/* Open Graph */}
  <meta property="og:type" content="website">
  <meta property="og:site_name" content={t('meta.title')}>
  <meta property="og:title" content={title}>
  <meta property="og:image" content="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/favicon/favicon-1080.jpg">
  <meta property="og:image:width" content="1080">
  <meta property="og:image:height" content="1080">
  <meta property="og:image:type" content="image/jpeg">
  <meta property="og:locale" content={locale}>

  {/* Twitter Card */}
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@KEA_live_">
  <meta name="twitter:creator" content="@KEA_live_">
  <meta name="twitter:title" content={title}>
  <meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/favicon/favicon-1080.jpg">

  {/* Bootstrap */}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" integrity="sha256-2FMn2Zx6PuH5tdBQDRNwrOo60ts5wWPC9R8jK67b3t4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" integrity="sha256-pdY4ejLKO67E0CM2tbPtq1DJ3VGDVVdqAR6j3ZwdiE4=" crossorigin="anonymous">

  <style is:inline>
    .blend-text{mix-blend-mode: difference;color:#fff;}
    /* Voice input recording animation */
    .mic-recording i{animation: pulse-mic 1.2s ease-in-out infinite;}
    @keyframes pulse-mic{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.7;transform:scale(1.15);}}
    /* TTS playing animation */
    .tts-playing i{animation: pulse-tts 1s ease-in-out infinite;}
    @keyframes pulse-tts{0%,100%{opacity:1;}50%{opacity:0.5;}}
    /* Utility classes for common patterns */
    .icon-xl{font-size: 3rem;}
    .icon-lg{font-size: 2rem;}
    .card-auth{max-width: 400px; width: 100%;}
    .chat-container-max{max-width: 1100px;}
    /* KEA brand utilities - Bootstrap-style */
    .text-kea{color:#323b1c;}
    [data-bs-theme="dark"] .text-kea{color:#a68d6f;}
    .btn-kea{--btn-bg:#323b1c;--btn-hover:#424d26;background-color:var(--btn-bg);border-color:var(--btn-bg);color:#fff;}
    .btn-kea:hover,.btn-kea:focus{background-color:var(--btn-hover);border-color:var(--btn-hover);color:#fff;}
    .btn-kea:active{background-color:#2a3117;border-color:#2a3117;color:#fff;}
    [data-bs-theme="dark"] .btn-kea{--btn-bg:#a68d6f;--btn-hover:#9a7c5a;color:#1a1a1a;}
    [data-bs-theme="dark"] .btn-kea:hover,[data-bs-theme="dark"] .btn-kea:focus{color:#1a1a1a;}
    [data-bs-theme="dark"] .btn-kea:active{background-color:#897455;border-color:#897455;color:#fff;}
    .btn-outline-kea{--btn-color:#323b1c;--btn-hover-bg:#323b1c;color:var(--btn-color);border-color:var(--btn-color);background-color:transparent;}
    .btn-outline-kea:hover,.btn-outline-kea:focus{background-color:var(--btn-hover-bg);border-color:var(--btn-hover-bg);color:#fff;}
    [data-bs-theme="dark"] .btn-outline-kea{--btn-color:#a68d6f;--btn-hover-bg:#a68d6f;}
    [data-bs-theme="dark"] .btn-outline-kea:hover,[data-bs-theme="dark"] .btn-outline-kea:focus{color:#1a1a1a;}
    .link-kea{color:#323b1c;}.link-kea:hover{color:#424d26;}
    [data-bs-theme="dark"] .link-kea{color:#a68d6f;}[data-bs-theme="dark"] .link-kea:hover{color:#9a7c5a;}
    .bg-kea{background-color:#323b1c !important;}
    [data-bs-theme="dark"] .bg-kea{background-color:#a68d6f !important;}
    .bg-kea-subtle{background-color:rgba(50, 59, 28, 0.15) !important;}
    [data-bs-theme="dark"] .bg-kea-subtle{background-color:rgba(166, 141, 111, 0.2) !important;}
    /* Settings modal nav-tabs KEA styling */
    #settingsModal .nav-link{color:#323b1c;}
    #settingsModal .nav-link:hover,#settingsModal .nav-link:focus{color:#424d26;}
    #settingsModal .nav-link.active{color:#323b1c;border-bottom-color:#323b1c;}
    [data-bs-theme="dark"] #settingsModal .nav-link{color:#a68d6f;}
    [data-bs-theme="dark"] #settingsModal .nav-link:hover,[data-bs-theme="dark"] #settingsModal .nav-link:focus{color:#9a7c5a;}
    [data-bs-theme="dark"] #settingsModal .nav-link.active{color:#a68d6f;border-bottom-color:#a68d6f;}
  </style>
</head>
<body class="d-flex flex-column vh-100 overflow-hidden">
  <slot />

  {/* Bootstrap JS */}
  <script is:inline src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script is:inline src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
  {/* Markdown rendering */}
  <script is:inline src="https://cdn.jsdelivr.net/npm/marked@17.0.1/lib/marked.umd.min.js"></script>
  {/* PDF and DOCX export */}
  <script is:inline src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.2/dist/html2pdf.bundle.min.js"></script>
  <script is:inline src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.min.js"></script>
  {/* MathJax 4.1.0 for math rendering */}
  <script is:inline>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      startup: {
        typeset: false
      }
    };
  </script>
  <script is:inline src="https://cdn.jsdelivr.net/npm/mathjax@4.1.0/tex-chtml.js" id="MathJax-script" async></script>

  {/* Inject translations for client-side JS */}
  <TranslationScript locale={locale} />
</body>
</html>
