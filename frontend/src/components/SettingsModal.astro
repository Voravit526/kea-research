---
import type { SupportedLocale } from '../i18n';
import { AVATARS } from '../scripts/settings-data';

interface Props {
  t: (key: string, vars?: Record<string, string | number>) => string;
  locale: SupportedLocale;
}

const { t, locale } = Astro.props;
---

<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">{t('settings.title')}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        {/* Tab Navigation */}
        <ul class="nav nav-tabs px-3" id="settingsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#settingsGeneral" type="button" role="tab" aria-controls="settingsGeneral" aria-selected="true">
              <i class="bi bi-gear me-1"></i> {t('settings.tabGeneral')}
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="appearance-tab" data-bs-toggle="tab" data-bs-target="#settingsAppearance" type="button" role="tab" aria-controls="settingsAppearance" aria-selected="false">
              <i class="bi bi-palette me-1"></i> {t('settings.tabAppearance')}
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tts-tab" data-bs-toggle="tab" data-bs-target="#settingsTts" type="button" role="tab" aria-controls="settingsTts" aria-selected="false">
              <i class="bi bi-volume-up me-1"></i> {t('settings.tabTts')}
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="storage-tab" data-bs-toggle="tab" data-bs-target="#settingsStorage" type="button" role="tab" aria-controls="settingsStorage" aria-selected="false">
              <i class="bi bi-database me-1"></i> {t('settings.tabStorage')}
            </button>
          </li>
        </ul>

        {/* Tab Content */}
        <div class="tab-content p-4">
          {/* General Tab */}
          <div class="tab-pane fade show active" id="settingsGeneral" role="tabpanel" aria-labelledby="general-tab">
            <div class="row mb-4">
              <div class="col-md-4 mb-3 mb-md-0" id="userNameGroup">
                <label for="userName" class="form-label fw-semibold">{t('settings.username')}</label>
                <input type="text" class="form-control" id="userName" placeholder={t('settings.usernamePlaceholder')} value="User">
              </div>
              <div class="col-md-4 mb-3 mb-md-0">
                <label for="themeSelect" class="form-label fw-semibold">{t('settings.theme')}</label>
                <select class="form-select" id="themeSelect">
                  <option value="light">{t('settings.themeLight')}</option>
                  <option value="dark">{t('settings.themeDark')}</option>
                  <option value="auto">{t('settings.themeAuto')}</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">{t('settings.language')}</label>
                {/* Custom searchable language dropdown  */}
                <div class="language-dropdown position-relative" id="languageDropdown">
                  <input type="text" class="form-control" id="languageSearch" autocomplete="off" readonly>
                  <input type="hidden" id="languageSelect" value={locale}>
                  <div class="language-dropdown-menu d-none" id="languageDropdownMenu">
                    <input type="text" class="form-control form-control-sm language-filter mb-2" id="languageFilter" placeholder="Search...">
                    <div class="language-options" id="languageOptions">
                      <div class="language-option" data-value="az">ğŸ‡¦ğŸ‡¿ AzÉ™rbaycan</div>
                      <div class="language-option" data-value="id">ğŸ‡®ğŸ‡© Bahasa Indonesia</div>
                      <div class="language-option" data-value="ms">ğŸ‡²ğŸ‡¾ Bahasa Melayu</div>
                      <div class="language-option" data-value="jv">ğŸ‡®ğŸ‡© Basa Jawa</div>
                      <div class="language-option" data-value="bs">ğŸ‡§ğŸ‡¦ Bosanski</div>
                      <div class="language-option" data-value="ca">ğŸ‡¦ğŸ‡© CatalÃ </div>
                      <div class="language-option" data-value="cy">ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿ Cymraeg</div>
                      <div class="language-option" data-value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</div>
                      <div class="language-option" data-value="da">ğŸ‡©ğŸ‡° Dansk</div>
                      <div class="language-option" data-value="de">ğŸ‡©ğŸ‡ª Deutsch</div>
                      <div class="language-option" data-value="et">ğŸ‡ªğŸ‡ª Eesti</div>
                      <div class="language-option" data-value="en">ğŸ‡ºğŸ‡¸ English (US)</div>
                      <div class="language-option" data-value="en-AU">ğŸ‡¦ğŸ‡º English (AU)</div>
                      <div class="language-option" data-value="en-GB">ğŸ‡¬ğŸ‡§ English (UK)</div>
                      <div class="language-option" data-value="en-IE">ğŸ‡®ğŸ‡ª English (IE)</div>
                      <div class="language-option" data-value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</div>
                      <div class="language-option" data-value="eu">ğŸ‡ªğŸ‡¸ Euskara</div>
                      <div class="language-option" data-value="fil">ğŸ‡µğŸ‡­ Filipino</div>
                      <div class="language-option" data-value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</div>
                      <div class="language-option" data-value="ga">ğŸ‡®ğŸ‡ª Gaeilge</div>
                      <div class="language-option" data-value="gl">ğŸ‡ªğŸ‡¸ Galego</div>
                      <div class="language-option" data-value="gd">ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ GÃ idhlig</div>
                      <div class="language-option" data-value="ha">ğŸ‡³ğŸ‡¬ Hausa</div>
                      <div class="language-option" data-value="hr">ğŸ‡­ğŸ‡· Hrvatski</div>
                      <div class="language-option" data-value="is">ğŸ‡®ğŸ‡¸ Ãslenska</div>
                      <div class="language-option" data-value="it">ğŸ‡®ğŸ‡¹ Italiano</div>
                      <div class="language-option" data-value="sw">ğŸ‡°ğŸ‡ª Kiswahili</div>
                      <div class="language-option" data-value="lv">ğŸ‡±ğŸ‡» LatvieÅ¡u</div>
                      <div class="language-option" data-value="lb">ğŸ‡±ğŸ‡º LÃ«tzebuergesch</div>
                      <div class="language-option" data-value="lt">ğŸ‡±ğŸ‡¹ LietuviÅ³</div>
                      <div class="language-option" data-value="hu">ğŸ‡­ğŸ‡º Magyar</div>
                      <div class="language-option" data-value="mt">ğŸ‡²ğŸ‡¹ Malti</div>
                      <div class="language-option" data-value="nl">ğŸ‡³ğŸ‡± Nederlands</div>
                      <div class="language-option" data-value="no">ğŸ‡³ğŸ‡´ Norsk</div>
                      <div class="language-option" data-value="pl">ğŸ‡µğŸ‡± Polski</div>
                      <div class="language-option" data-value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</div>
                      <div class="language-option" data-value="pt-BR">ğŸ‡§ğŸ‡· PortuguÃªs (Brasil)</div>
                      <div class="language-option" data-value="ro">ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ</div>
                      <div class="language-option" data-value="sq">ğŸ‡¦ğŸ‡± Shqip</div>
                      <div class="language-option" data-value="sk">ğŸ‡¸ğŸ‡° SlovenÄina</div>
                      <div class="language-option" data-value="sl">ğŸ‡¸ğŸ‡® SlovenÅ¡Äina</div>
                      <div class="language-option" data-value="fi">ğŸ‡«ğŸ‡® Suomi</div>
                      <div class="language-option" data-value="sv">ğŸ‡¸ğŸ‡ª Svenska</div>
                      <div class="language-option" data-value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</div>
                      <div class="language-option" data-value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</div>
                      <div class="language-option" data-value="yo">ğŸ‡³ğŸ‡¬ Yoruba</div>
                      <div class="language-option" data-value="el">ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬</div>
                      <div class="language-option" data-value="be">ğŸ‡§ğŸ‡¾ Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞºĞ°Ñ</div>
                      <div class="language-option" data-value="bg">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸</div>
                      <div class="language-option" data-value="kk">ğŸ‡°ğŸ‡¿ ÒšĞ°Ğ·Ğ°Ò›ÑˆĞ°</div>
                      <div class="language-option" data-value="mk">ğŸ‡²ğŸ‡° ĞœĞ°ĞºĞµĞ´Ğ¾Ğ½ÑĞºĞ¸</div>
                      <div class="language-option" data-value="sr">ğŸ‡·ğŸ‡¸ Ğ¡Ñ€Ğ¿ÑĞºĞ¸</div>
                      <div class="language-option" data-value="uk">ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</div>
                      <div class="language-option" data-value="ka">ğŸ‡¬ğŸ‡ª áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜</div>
                      <div class="language-option" data-value="hy">ğŸ‡¦ğŸ‡² Õ€Õ¡ÕµÕ¥Ö€Õ¥Õ¶</div>
                      <div class="language-option" data-value="he">ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª</div>
                      <div class="language-option" data-value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
                      <div class="language-option" data-value="fa">ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ</div>
                      <div class="language-option" data-value="ur">ğŸ‡µğŸ‡° Ø§Ø±Ø¯Ùˆ</div>
                      <div class="language-option" data-value="am">ğŸ‡ªğŸ‡¹ áŠ áˆ›áˆ­áŠ›</div>
                      <div class="language-option" data-value="bn">ğŸ‡§ğŸ‡© à¦¬à¦¾à¦‚à¦²à¦¾</div>
                      <div class="language-option" data-value="gu">ğŸ‡®ğŸ‡³ àª—à«àªœàª°àª¾àª¤à«€</div>
                      <div class="language-option" data-value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</div>
                      <div class="language-option" data-value="pa">ğŸ‡®ğŸ‡³ à¨ªà©°à¨œà¨¾à¨¬à©€</div>
                      <div class="language-option" data-value="kn">ğŸ‡®ğŸ‡³ à²•à²¨à³à²¨à²¡</div>
                      <div class="language-option" data-value="mr">ğŸ‡®ğŸ‡³ à¤®à¤°à¤¾à¤ à¥€</div>
                      <div class="language-option" data-value="ta">ğŸ‡®ğŸ‡³ à®¤à®®à®¿à®´à¯</div>
                      <div class="language-option" data-value="te">ğŸ‡®ğŸ‡³ à°¤à±†à°²à±à°—à±</div>
                      <div class="language-option" data-value="my">ğŸ‡²ğŸ‡² á€™á€¼á€”á€ºá€™á€¬á€…á€¬</div>
                      <div class="language-option" data-value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</div>
                      <div class="language-option" data-value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (ç®€ä½“)</div>
                      <div class="language-option" data-value="zh-TW">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ (ç¹é«”)</div>
                      <div class="language-option" data-value="zh-HK">ğŸ‡­ğŸ‡° ä¸­æ–‡ (é¦™æ¸¯)</div>
                      <div class="language-option" data-value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</div>
                      <div class="language-option" data-value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="sendOnEnterToggle" checked>
                <label class="form-check-label fw-semibold" for="sendOnEnterToggle">
                  {t('settings.sendOnEnter')}
                </label>
              </div>
              <small class="text-body-secondary" id="sendOnEnterHint">
                {t('settings.sendOnEnterHintEnabled')}
              </small>
            </div>

            <div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="compressAttachedImagesToggle" checked>
                <label class="form-check-label fw-semibold" for="compressAttachedImagesToggle">
                  {t('settings.compressImages')}
                </label>
              </div>
              <small class="text-body-secondary">
                {t('settings.compressImagesDesc')}
              </small>
              <div id="compressionOptions" class="mt-2 ps-3 border-start">
                <div class="row g-2 align-items-center">
                  <div class="col-6">
                    <label for="compressionQuality" class="form-label small mb-0">{t('settings.quality')}: <strong id="compressionQualityValue">85%</strong></label>
                    <input type="range" class="form-range form-range-sm" min="50" max="100" step="5" value="85" id="compressionQuality">
                  </div>
                  <div class="col-6">
                    <label for="compressionMaxDimension" class="form-label small mb-0">{t('settings.maxDimension')}: <strong id="compressionMaxDimensionValue">2048px</strong></label>
                    <input type="range" class="form-range form-range-sm" min="1024" max="8192" step="512" value="2048" id="compressionMaxDimension">
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Appearance Tab */}
          <div class="tab-pane fade" id="settingsAppearance" role="tabpanel" aria-labelledby="appearance-tab">
            <div class="mb-4">
              <label class="form-label fw-semibold">{t('settings.avatar')}</label>
              <div class="d-flex gap-2 flex-wrap mb-2" id="avatarOptions">
                {AVATARS.map((avatar) => (
                  <button class="btn btn-outline-secondary p-2 avatar-option" data-avatar={avatar}>{avatar}</button>
                ))}
              </div>
              <div>
                <label for="customAvatarUpload" class="btn btn-outline-kea w-100">
                  <i class="bi bi-upload"></i> {t('settings.uploadAvatar')}
                  <span id="avatarUploadStatus" class="d-none ms-2 text-success"></span>
                </label>
                <input type="file" id="customAvatarUpload" class="d-none" accept="image/*">
              </div>
            </div>

            <div>
              <label class="form-label fw-semibold">{t('settings.chatBackground')}</label>
              <div class="d-flex flex-nowrap gap-2 overflow-x-auto pb-2 mb-2" id="backgroundOptions">
                <button class="btn btn-outline-secondary p-0 bg-option flex-shrink-0" data-bg="none">
                  <div class="d-flex align-items-center justify-content-center rounded bg-body-tertiary px-4 py-5">
                    <span class="text-body-secondary small">{t('settings.backgroundNone')}</span>
                  </div>
                </button>
                <button class="btn btn-outline-secondary p-0 bg-option flex-shrink-0" data-bg="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg1.jpg">
                  <img src="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg1-200.jpg" class="rounded" alt="Gradient">
                </button>
                <button class="btn btn-outline-secondary p-0 bg-option flex-shrink-0" data-bg="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg2.jpg">
                  <img src="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg2-200.jpg" class="rounded" alt="Abstract">
                </button>
                <button class="btn btn-outline-secondary p-0 bg-option flex-shrink-0" data-bg="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg3.jpg">
                  <img src="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg3-200.jpg" class="rounded" alt="Pattern">
                </button>
                <button class="btn btn-outline-secondary p-0 bg-option flex-shrink-0" data-bg="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg4.jpg">
                  <img src="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg4-200.jpg" class="rounded" alt="Pattern">
                </button>
                <button class="btn btn-outline-secondary p-0 bg-option flex-shrink-0" data-bg="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg5.jpg">
                  <img src="https://cdn.jsdelivr.net/gh/keabase/web@main/dist/img/chat-bg/bg5-200.jpg" class="rounded" alt="Pattern">
                </button>
              </div>
              <div>
                <label for="customBgUpload" class="btn btn-outline-kea w-100">
                  <i class="bi bi-upload"></i> {t('settings.uploadBackground')}
                  <span id="bgUploadStatus" class="d-none ms-2 text-success"></span>
                </label>
                <input type="file" id="customBgUpload" class="d-none" accept="image/*">
              </div>
            </div>
          </div>

          {/* Text-to-Speech Tab */}
          <div class="tab-pane fade" id="settingsTts" role="tabpanel" aria-labelledby="tts-tab">
            {/* Admin disabled warning */}
            <div class="alert alert-warning d-none" id="ttsAdminDisabledAlert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              {t('settings.ttsDisabledByAdmin')}
            </div>

            <div id="ttsControlsContainer">
              <div class="mb-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="ttsEnabledToggle">
                  <label class="form-check-label fw-semibold" for="ttsEnabledToggle">
                    {t('settings.ttsEnabled')}
                  </label>
                </div>
                <small class="text-body-secondary">
                  {t('settings.ttsEnabledDesc')}
                </small>
              </div>

              <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                  <label for="ttsLanguageSelect" class="form-label fw-semibold">{t('settings.ttsLanguage')}</label>
                  <select class="form-select" id="ttsLanguageSelect">
                    <option value="en-us">English (US)</option>
                    <option value="en-gb">English (UK)</option>
                    <option value="ja">Japanese</option>
                    <option value="zh">Chinese</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="hi">Hindi</option>
                    <option value="it">Italian</option>
                    <option value="pt">Portuguese (BR)</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="ttsVoiceSelect" class="form-label fw-semibold">{t('settings.ttsVoice')}</label>
                  <select class="form-select" id="ttsVoiceSelect">
                    {/* Populated dynamically based on language */}
                  </select>
                </div>
              </div>

              <div class="mb-4">
                <label for="ttsSpeedRange" class="form-label fw-semibold">{t('settings.ttsSpeed')}: <strong id="ttsSpeedValue">1.0x</strong></label>
                <input type="range" class="form-range" min="0.5" max="2" step="0.1" value="1" id="ttsSpeedRange">
                <div class="d-flex justify-content-between">
                  <small class="text-body-secondary">0.5x</small>
                  <small class="text-body-secondary">2.0x</small>
                </div>
              </div>

              <button class="btn btn-outline-kea w-100" id="ttsPreviewBtn">
                <i class="bi bi-play-circle me-1"></i> {t('settings.ttsPreview')}
              </button>
            </div>
          </div>

          {/* Storage Tab */}
          <div class="tab-pane fade" id="settingsStorage" role="tabpanel" aria-labelledby="storage-tab">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <span class="text-body-secondary">{t('settings.currentUsage')}</span>
                  <strong id="storageUsed">{t('settings.calculating')}</strong>
                </div>
                <div class="progress mb-3" role="progressbar" aria-label="Storage usage">
                  <div class="progress-bar" id="storageProgressBar"></div>
                </div>
                <div class="mb-3">
                  <label for="storageLimitRange" class="form-label text-body-secondary">{t('settings.storageLimit')}: <strong id="storageLimitValue">32 MB</strong></label>
                  <input type="range" class="form-range" min="32" max="256" step="32" value="32" id="storageLimitRange">
                  <div class="d-flex justify-content-between">
                    <small class="text-body-secondary">32 MB</small>
                    <small class="text-body-secondary">256 MB</small>
                  </div>
                </div>
                <button class="btn btn-outline-danger w-100" id="clearStorageBtn">
                  <i class="bi bi-trash"></i> {t('settings.clearStorage')}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">{t('common.close')}</button>
        <button type="button" class="btn btn-kea rounded-pill" id="saveSettings">{t('common.saveChanges')}</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Custom searchable language dropdown */
  .language-dropdown {
    position: relative;
  }

  #languageSearch {
    cursor: pointer;
    background-color: var(--bs-body-bg);
  }

  #languageSearch::after {
    content: 'â–¼';
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.7em;
    pointer-events: none;
  }

  .language-dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1050;
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    padding: 0.5rem;
    margin-top: 2px;
  }

  .language-options {
    max-height: 250px;
    overflow-y: auto;
  }

  .language-option {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-radius: 0.25rem;
    transition: background-color 0.15s;
  }

  .language-option:hover {
    background-color: var(--bs-tertiary-bg);
  }

  .language-option.active {
    background-color: var(--bs-primary);
    color: white;
  }

  .language-option.d-none {
    display: none !important;
  }
</style>
